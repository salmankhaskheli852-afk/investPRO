
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if the user is a super admin by email
    // or if their UID exists in the admin roles collection.
    function isAdmin() {
      return request.auth != null && 
             (
                request.auth.token.email == 'salmankhaskheli885@gmail.com' ||
                exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid))
             );
    }
    
    // Helper function to check if the user is an agent by their role document.
    function isAgent() {
      return request.auth != null &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'agent';
    }

    // Grant ADMINS total and complete access to ALL documents in the database.
    match /{document=**} {
      allow read, write: if isAdmin();
    }
    
    // Grant AGENTS broad access to necessary collections.
    // This allows them to manage users, plans, and transactions without restriction.
    match /{collection}/{docId} {
      allow read, write, list: if isAgent() && 
                                 collection in ['users', 'investment_plans', 'plan_categories', 'transactions', 'admin_wallets', 'withdrawal_methods', 'referral_requests'];
    }
     match /users/{userId}/{subCollection}/{docId} {
        allow read, write, list: if isAgent();
    }
     match /users/{userId}/{subCollection}/{docId}/{nestedSubCollection}/{nestedDocId} {
        allow read, write, list: if isAgent();
    }


    // --- Rules for regular authenticated users (non-admin, non-agent) ---

    function isUserAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isUserAuthenticated() && request.auth.uid == userId;
    }

    // A user can read and update their own profile.
    match /users/{userId} {
      allow get, update: if isOwner(userId);
      allow create: if isUserAuthenticated();
    }
    
    // Any user (authenticated or not) can read plans.
    // Authenticated users can update plans (to increment purchase count).
    // Only admins/agents can create/delete them.
    match /investment_plans/{planId} {
        allow read: if true;
        allow update: if isUserAuthenticated();
        allow create, delete: if isAdmin() || isAgent();
    }

    // Any authenticated user can view plan categories.
    match /plan_categories/{categoryId} {
        allow read: if isUserAuthenticated();
    }
    
    // A user has full access to their own sub-collections (wallets, transactions, etc.).
    // This recursive wildcard match is crucial for nested data like transactions.
    match /users/{userId}/{document=**} {
      allow read, write: if isOwner(userId);
    }
    
    // Any authenticated user can read admin wallet details for depositing.
    match /admin_wallets/{walletId} {
        allow read: if isUserAuthenticated();
    }

    // Any authenticated user can read withdrawal methods.
    match /withdrawal_methods/{methodId} {
      allow read: if isUserAuthenticated();
    }

    // Anyone can read chat settings for the WhatsApp widget.
    match /app_config/{setting} {
      allow get: if true;
    }

    // Admins can list transactions. Regular users can create new ones.
    match /transactions/{transactionId} {
      allow create: if isUserAuthenticated();
      allow list: if isAdmin() || isAgent();
    }
    
    // Rules for the new referral request system
    match /referral_requests/{requestId} {
      // Allow creation if the requester is the authenticated user and the request is 'pending'.
      allow create: if isUserAuthenticated() && request.resource.data.requesterId == request.auth.uid && request.resource.data.status == 'pending';

      // Allow the requester and the target user to read the request.
      allow read: if isUserAuthenticated() && (resource.data.requesterId == request.auth.uid || resource.data.targetId == request.auth.uid);

      // Allow the target user to update the status (to 'approved' or 'rejected') if it's currently 'pending'.
      allow update: if isUserAuthenticated() && resource.data.targetId == request.auth.uid && resource.data.status == 'pending' && request.resource.data.status in ['approved', 'rejected'];
    }
  }
}
