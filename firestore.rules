
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if the user is a super admin by email
    // or if their UID exists in the admin roles collection.
    function isAdmin() {
      return request.auth != null && 
             (
                request.auth.token.email == 'salmankhaskheli885@gmail.com' ||
                exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid))
             );
    }

    // Helper function to check if the user is an agent by their role document.
    // IMPORTANT: It now checks for the existence of the user document first to prevent errors on new user registration.
    function isAgent() {
      return request.auth != null &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'agent';
    }
    
    // --- Rules for regular authenticated users (non-admin, non-agent) ---

    function isUserAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isUserAuthenticated() && request.auth.uid == userId;
    }

    // Allow any authenticated user to read profiles for referral checks.
    // Allow any user with a valid auth object to create their own profile.
    // Only the owner can update their own profile.
    match /users/{userId} {
      allow get, list: if isUserAuthenticated();
      allow create: if request.auth != null; // Allow creation if user is signing up
      allow update: if isOwner(userId);
    }
    
    // A user has full access to their own sub-collections (wallets, transactions, etc.).
    match /users/{userId}/{document=**} {
      allow read, write: if isOwner(userId);
    }

    // Allow creation and writing to the user id counter by any user with a valid auth object
    match /counters/{counterId} {
        allow read: if isUserAuthenticated();
        allow write: if request.auth != null;
    }
    
    // --- Admin and Agent Rules (Checked AFTER user rules) ---

    // Grant ADMINS total and complete access to ALL documents in the database.
    match /{document=**} {
      allow read, write: if isAdmin();
    }

    // Grant AGENTS broad access to necessary collections.
    match /{collection}/{docId} {
      allow read, write, list: if isAgent() && 
                                 collection in ['users', 'investment_plans', 'plan_categories', 'transactions', 'admin_wallets', 'withdrawal_methods', 'password_reset_requests'];
    }
     match /users/{userId}/{subCollection}/{docId} {
        allow read, write, list: if isAgent();
    }
     match /users/{userId}/{subCollection}/{docId}/{nestedSubCollection}/{nestedDocId} {
        allow read, write, list: if isAgent();
    }


    // --- General Public/Authenticated Read Rules ---

    // Any user (authenticated or not) can read plans.
    // Authenticated users can update plans (to increment purchase count).
    match /investment_plans/{planId} {
        allow read: if true;
        allow update: if isUserAuthenticated();
        allow create, delete: if isAdmin() || isAgent();
    }

    // Any authenticated user can view plan categories.
    match /plan_categories/{categoryId} {
        allow read: if isUserAuthenticated();
        allow create, update, delete: if isAdmin() || isAgent();
    }
    
    // Any authenticated user can read admin wallet details for depositing.
    match /admin_wallets/{walletId} {
        allow read: if isUserAuthenticated();
    }

    // Any authenticated user can read withdrawal methods.
    match /withdrawal_methods/{methodId} {
      allow read: if isUserAuthenticated();
    }

    // Anyone can read chat settings for the WhatsApp widget.
    match /app_config/{setting} {
      allow get: if true;
    }
    
    // Allow any authenticated user to create a password reset request
    match /password_reset_requests/{requestId} {
        allow create: if isUserAuthenticated();
        allow read, write: if isAdmin() || isAgent();
    }

    // Regular users can create new transactions and list them (for duplicate TID check).
    // Admins/Agents have broader list permissions from their own rules.
    match /transactions/{transactionId} {
      allow create: if isUserAuthenticated();
      allow list: if isUserAuthenticated();
    }
    
    // Allow creation and writing to the referral requests
    match /referral_requests/{requestId} {
        allow create: if isUserAuthenticated();
        allow read, update: if isUserAuthenticated() && (request.auth.uid == resource.data.requesterId || request.auth.uid == resource.data.targetId);
    }
  }
}
